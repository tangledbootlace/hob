# HOB.Worker Infrastructure

This directory contains infrastructure configuration for the HOB Worker service, which processes report generation jobs from RabbitMQ.

## Overview

The HOB Worker is designed to run as a **scheduled job** rather than a long-running service:

- **Trigger**: Every 5 minutes via GitHub Actions cron schedule
- **Process**: Consumes report generation messages from RabbitMQ
- **Output**: CSV reports written to `/reports` volume
- **Lifecycle**: Start → Process messages → Wait 30s for new messages → Exit gracefully
- **Auto-shutdown**: Built-in queue drain observer triggers shutdown after 30 seconds of queue inactivity

## Files

- **docker-compose.worker.yml** - Docker Compose configuration for worker job
- **run-worker.sh** - Shell script to execute worker job (used by GitHub Actions)
- **README.md** - This file

## Deployment Methods

### 1. GitHub Actions (Recommended)

The worker is automatically triggered every 5 minutes via GitHub Actions workflow:

```yaml
schedule:
  - cron: '*/5 * * * *'  # Every 5 minutes
```

See `.github/workflows/worker-schedule.yml` for the full workflow configuration.

### 2. Manual Execution

Run the worker manually using the shell script:

```bash
# Set required environment variables
export DOCKER_REGISTRY="ghcr.io"
export IMAGE_TAG="latest"
export DB_PASSWORD="your-password"
export RABBITMQ_USER="local"
export RABBITMQ_PASSWORD="your-password"
export REPORTS_VOLUME_PATH="/opt/hob/reports"

# Execute worker
./HOB.Worker/infrastructure/run-worker.sh
```

### 3. Docker Compose

Run using Docker Compose:

```bash
cd HOB.Worker/infrastructure

# Set environment variables
export DOCKER_REGISTRY="ghcr.io"
export IMAGE_TAG="latest"
export DB_PASSWORD="your-password"
export RABBITMQ_USER="local"
export RABBITMQ_PASSWORD="your-password"
export REPORTS_VOLUME_PATH="/opt/hob/reports"
export RUN_ID="$(date +%s)"

# Run worker
docker-compose -f docker-compose.worker.yml up --abort-on-container-exit
```

### 4. Direct Docker Run

Execute worker container directly:

```bash
docker run --rm \
  --name hob-worker-$(date +%s) \
  --network hob-network \
  -e DOTNET_ENVIRONMENT=Production \
  -e "ConnectionStrings__DefaultConnection=Server=hob-db;Database=HOB;User Id=sa;Password=YOUR_PASSWORD;TrustServerCertificate=True;" \
  -e "ConnectionStrings__RabbitMQ=amqp://local:local@hob-rabbitmq:5672" \
  -e "ReportSettings__OutputDirectory=/reports" \
  -v /opt/hob/reports:/reports \
  ghcr.io/tangledbootlace/hob-worker:latest
```

## Environment Variables

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| DOTNET_ENVIRONMENT | .NET environment | No | Production |
| ConnectionStrings__DefaultConnection | SQL Server connection | Yes | - |
| ConnectionStrings__RabbitMQ | RabbitMQ connection | Yes | - |
| DB_PASSWORD | Database password | Yes | - |
| RABBITMQ_USER | RabbitMQ username | Yes | - |
| RABBITMQ_PASSWORD | RabbitMQ password | Yes | - |
| ReportSettings__OutputDirectory | Output directory for reports | No | /reports |
| REPORTS_VOLUME_PATH | Host path for reports volume | No | /opt/hob/reports |
| DOCKER_REGISTRY | Docker registry | No | ghcr.io |
| IMAGE_TAG | Docker image tag | No | latest |
| RUN_ID | Unique identifier for this run | No | manual |

## Worker Lifecycle

1. **Startup**: Worker container starts and connects to RabbitMQ
2. **Processing**: Consumes `GenerateReportCommand` messages from queue
3. **Report Generation**: Creates CSV reports in `/reports` directory
4. **Queue Monitoring**: Queue drain observer monitors for new messages
5. **Idle Detection**: After 30 seconds with no messages, triggers shutdown
6. **Graceful Exit**: Worker completes current tasks and exits cleanly

## Scheduling

### Cron Schedule

The worker runs every 5 minutes: `*/5 * * * *`

**Examples:**
- 00:00, 00:05, 00:10, 00:15, ...
- Runs 288 times per day
- Processes any pending report requests

### Custom Schedule

To change the schedule, modify `.github/workflows/worker-schedule.yml`:

```yaml
schedule:
  - cron: '*/10 * * * *'  # Every 10 minutes
  - cron: '0 * * * *'     # Every hour
  - cron: '0 0 * * *'     # Daily at midnight
```

## Reports Output

Generated reports are stored in the configured reports volume:

- **Host path**: `/opt/hob/reports` (configurable via `REPORTS_VOLUME_PATH`)
- **Container path**: `/reports`
- **Format**: CSV files
- **Naming**: Generated by worker service
- **Persistence**: Reports persist after worker exits

### Report Access

Access generated reports:

```bash
# List reports
ls -lh /opt/hob/reports

# View latest report
cat /opt/hob/reports/latest.csv

# Copy report to local machine
scp user@server:/opt/hob/reports/*.csv ./
```

## Monitoring

### Container Logs

View worker execution logs:

```bash
# Via Docker
docker logs hob-worker-<run-id>

# Via GitHub Actions
# Check the workflow run logs in GitHub Actions UI
```

### OpenTelemetry

Worker sends traces to Jaeger:
- **Service Name**: HOB.Worker
- **Jaeger UI**: http://jaeger.hob.localhost
- View worker execution spans and performance

### Execution History

Check worker execution history:

```bash
# List recent worker containers
docker ps -a --filter "label=com.hob.service=report-generator"

# View container details
docker inspect hob-worker-<run-id>
```

## Troubleshooting

### Worker doesn't start

1. Verify infrastructure stack is running
2. Check network connectivity: `docker network inspect hob-network`
3. Validate environment variables are set
4. Review image availability: `docker pull ghcr.io/tangledbootlace/hob-worker:latest`

### Worker exits immediately

1. Check container logs: `docker logs hob-worker-<run-id>`
2. Verify RabbitMQ connection
3. Check database connectivity
4. Review configuration settings

### Reports not generated

1. Verify queue has messages: Check RabbitMQ management UI
2. Check worker logs for errors
3. Verify reports volume is writable: `ls -la /opt/hob/reports`
4. Check disk space: `df -h`

### Worker runs too long

1. Review queue drain observer configuration (30s default)
2. Check for stuck messages in RabbitMQ
3. Monitor worker processing performance in Jaeger
4. Increase timeout if needed (requires code change)

### GitHub Actions workflow fails

1. Check workflow logs in Actions UI
2. Verify secrets are configured correctly
3. Ensure server is accessible from GitHub
4. Review SSH connection settings

## Security Considerations

- **Credentials**: Use GitHub Secrets for passwords and tokens
- **Network**: Worker should only access hob-network
- **Volumes**: Restrict reports directory permissions
- **Registry**: Use authenticated registry access
- **Least Privilege**: Worker runs with minimal required permissions

## Performance Tuning

### Execution Frequency

Adjust cron schedule based on:
- Report generation volume
- Queue message frequency
- Server resource availability
- Business requirements

### Container Resources

Limit worker resource usage:

```yaml
services:
  hob-worker:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

### Queue Configuration

Optimize RabbitMQ settings:
- Prefetch count
- Message TTL
- Queue durability
- Dead letter exchanges

## Best Practices

1. **Monitoring**: Always review worker logs after execution
2. **Alerting**: Set up notifications for worker failures
3. **Cleanup**: Regularly archive old reports
4. **Testing**: Test worker locally before deploying changes
5. **Versioning**: Tag worker images with semantic versions
6. **Rollback**: Keep previous image versions for quick rollback
